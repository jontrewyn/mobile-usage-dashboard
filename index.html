
// ---- JSON-only mode: fetch dashboard_data.json from the same repo ----
const JSON_URL = './dashboard_data.json';

// Globals
let allUsers = [], filteredUsers = [];
let sortKey = "total_usage_gb", sortDir = -1, page = 0, pageSize = 20;

// Utils
function z(n){ return String(n).padStart(2,"0"); }
function updateTimestamp(){
  const d = new Date();
  const el = document.getElementById("last-updated");
  if (el) el.textContent =
    `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}
function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

// Notifications (simple)
function showNotification(message, type = 'info'){
  const colors = {
    success: 'bg-green-600',
    error:   'bg-red-600',
    warning: 'bg-amber-600',
    info:    'bg-blue-600'
  };
  const n = document.createElement('div');
  n.className = `fixed top-4 right-4 z-50 text-white px-4 py-2 rounded-lg shadow-lg ${colors[type]||colors.info}`;
  n.textContent = message;
  document.body.appendChild(n);
  const fadeOut = () => { n.style.transition='opacity .3s'; n.style.opacity='0'; setTimeout(()=>n.remove(), 300); };
  setTimeout(fadeOut, 2500);
}

// Charts
function renderGauge(pct){
  const el = document.getElementById("speedometer-gauge");
  if (!el) return;
  const chart = echarts.init(el);
  chart.setOption({
    series: [{
      type: "gauge", startAngle: 180, endAngle: 0, min: 0, max: 100,
      radius: "90%", center: ["50%","75%"],
      axisLine: { lineStyle: { width: 20, color: [[0.7,"#22c55e"],[0.9,"#f59e0b"],[1.0,"#ef4444"]] } },
      pointer: { length: "70%", width: 6, itemStyle:{ color:"auto" } },
      axisTick: { distance: -25, length: 8, lineStyle:{ color:"#fff", width:2 } },
      splitLine: { distance: -30, length: 15, lineStyle:{ color:"#fff", width:2 } },
      axisLabel: { color:"#374151", distance:-50, fontSize:12, formatter:v=>v+"%" },
      detail: { valueAnimation:true, formatter:v=>Math.round(v)+"%", color:"#111827", fontSize:24, fontWeight:"bold", offsetCenter:[0,"-10%"] },
      data: [{ value: pct, name: "Usage %" }]
    }]
  });
  window.addEventListener("resize", ()=>chart.resize());
}
function renderDonut(id, seriesData){
  const el = document.getElementById(id);
  if (!el) return;
  const chart = echarts.init(el);
  chart.setOption({
    tooltip: { trigger: "item" },
    series: [{ type: "pie", radius: ["40%","70%"], label: { formatter: "{b}\n{c} GB ({d}%)" }, data: seriesData }]
  });
  window.addEventListener("resize", ()=>chart.resize());
}

// KPI + Table
function renderKPIsFromUsers(users){
  const sum = (a,b)=>a+b;
  const totalUsers = users.length;
  const totalEnt = users.map(u=>u.entitled_gb).reduce(sum,0);
  const totalUse = users.map(u=>u.total_usage_gb).reduce(sum,0);
  const overallPct = totalEnt ? (totalUse/totalEnt)*100 : 0;
  const avgPerUser = totalUsers ? totalUse/totalUsers : 0;

  document.getElementById("total-users").textContent = totalUsers.toLocaleString();
  document.getElementById("total-usage").textContent = `${totalUse.toFixed(1)} GB`;
  document.getElementById("entitled-total").textContent = totalEnt.toFixed(1);
  document.getElementById("avg-per-user").textContent = `${avgPerUser.toFixed(1)} GB`;
  document.getElementById("overall-bar").style.width = `${Math.min(overallPct,100).toFixed(1)}%`;
  document.getElementById("overall-pct-label").textContent = `${overallPct.toFixed(1)}% of allocation used`;
  document.getElementById("gauge-value").textContent = `${totalUse.toFixed(1)} GB`;
  document.getElementById("gauge-entitled").textContent = totalEnt.toFixed(1);

  const badge = document.getElementById("gauge-status");
  if (overallPct >= 150) { badge.textContent = `Critical: ${overallPct.toFixed(1)}% used`; badge.classList.remove("hidden"); }
  else if (overallPct >= 100) { badge.textContent = `Over Allocation: ${overallPct.toFixed(1)}%`; badge.classList.remove("hidden"); }
  else { badge.classList.add("hidden"); }

  renderGauge(Math.min(overallPct, 100));

  const apac = users.filter(u=>u.region==="APAC");
  const global = users.filter(u=>u.region==="Global");
  const apUse = apac.map(u=>u.total_usage_gb).reduce(sum,0);
  const glUse = global.map(u=>u.total_usage_gb).reduce(sum,0);
  const apEnt = apac.map(u=>u.entitled_gb).reduce(sum,0);
  const glEnt = global.map(u=>u.entitled_gb).reduce(sum,0);

  document.getElementById("apac-users").textContent = apac.length;
  document.getElementById("global-users").textContent = global.length;
  document.getElementById("avg-usage").textContent = `${avgPerUser.toFixed(1)} GB`;
  document.getElementById("contract-types").textContent = new Set(users.map(u=>String(u.vas_code||"").split(" ")[0])).size;

  document.getElementById("apac-usage").textContent = `${apUse.toFixed(1)} GB`;
  document.getElementById("apac-entitled").textContent = apEnt.toFixed(1);
  document.getElementById("apac-pct").textContent = apEnt ? ((apUse/apEnt)*100).toFixed(1) : "0.0";
  renderDonut("apac-chart", [
    {name:"Usage", value:Number(apUse.toFixed(1))},
    {name:"Remain", value:Number(Math.max(apEnt-apUse,0).toFixed(1))}
  ]);

  document.getElementById("global-usage").textContent = `${glUse.toFixed(1)} GB`;
  document.getElementById("global-entitled").textContent = glEnt.toFixed(1);
  document.getElementById("global-pct").textContent = glEnt ? ((glUse/glEnt)*100).toFixed(1) : "0.0";
  renderDonut("global-chart", [
    {name:"Usage", value:Number(glUse.toFixed(1))},
    {name:"Remain", value:Number(Math.max(glEnt-glUse,0).toFixed(1))}
  ]);
}

function renderTable(data){
  data.sort((a,b)=> (a[sortKey] > b[sortKey] ? sortDir : -sortDir));
  const start = page*pageSize, slice = data.slice(start, start+pageSize);
  const tbody = document.getElementById("users-table-body");
  tbody.innerHTML = "";
  for (const u of slice){
    const pct = u.usage_percentage;
    const barColor = pct>=100? "#ef4444" : (pct>=70? "#f59e0b" : "#22c55e");
    const status = pct>=150 ? `<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Critical</span>`
                : pct>=100 ? `<span class="px-2 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">Over</span>`
                            : `<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">OK</span>`;
    const tr = document.createElement("tr");
    tr.className = "border-b border-gray-200 hover:bg-gray-50 transition-colors";
    tr.innerHTML = `
      <td class="py-3 px-4 font-mono text-sm text-gray-900">${escapeHtml(u.user_id)}</td>
      <td class="py-3 px-4 text-sm text-gray-700"><span class="px-2 py-1 rounded-full text-xs font-medium ${u.region==='APAC'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${u.region}</span></td>
      <td class="py-3 px-4 text-sm text-gray-700">${escapeHtml(u.department)}</td>
      <td class="py-3 px-4 text-right font-mono text-sm font-medium text-gray-900">${u.total_usage_gb.toFixed(2)}</td>
      <td class="py-3 px-4"><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(pct,100)}%; background:${barColor}"></div></div></td>
      <td class="py-3 px-4">${status}</td>
    `;
    tbody.appendChild(tr);
  }
  document.getElementById("showing-count").textContent = slice.length;
  document.getElementById("total-count").textContent = data.length;
}

// Filters/sorting/paging
function applyFilters(){
  const q = (document.getElementById("user-search").value ?? "").toLowerCase();
  const r = document.getElementById("region-filter").value;
  filteredUsers = allUsers.filter(u=>{
    const inRegion = (r==="all") || (u.region===r);
    const text = (u.user_id+" "+u.region+" "+u.department+" "+(u.vas_code||"")).toLowerCase();
    return inRegion && text.includes(q);
  });
  page = 0;
  renderKPIsFromUsers(filteredUsers);
  renderTable(filteredUsers);
}
function sortTable(key){ if (sortKey===key) sortDir*=-1; else { sortKey = key; sortDir = -1; } renderTable(filteredUsers); }
function nextPage(){ if ((page+1)*pageSize < filteredUsers.length){ page++; renderTable(filteredUsers); } }
function previousPage(){ if (page>0){ page--; renderTable(filteredUsers); } }

// -------------------- ACTIONS --------------------

// Export CSV
function exportCSV(){
  const rows = filteredUsers.length ? filteredUsers : allUsers;
  const headers = ['User ID','Region','Department','Usage (GB)','Entitled (GB)','Usage %'];
  const data = rows.map(u => [
    u.user_id, u.region, u.department,
    u.total_usage_gb, u.entitled_gb, u.usage_percentage
  ]);
  const csv = [headers, ...data]
    .map(r => r.map(f => `"${String(f).replace(/"/g,'""')}"`).join(','))
    .join('\n');
  downloadFile(csv, 'roaming-data-usage.csv', 'text/csv;charset=utf-8;');
  showNotification('CSV downloaded', 'success');
}

// Export PDF (jsPDF + autoTable)
function exportPDF(){
  try{
    const rows = filteredUsers.length ? filteredUsers : allUsers;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });

    doc.setFontSize(14);
    doc.text('Roaming Data Usage - Current View', 40, 40);

    const body = rows.map(u => [
      u.user_id,
      u.region,
      u.department,
      u.total_usage_gb.toFixed(2),
      u.entitled_gb,
      u.usage_percentage
    ]);

    doc.autoTable({
      startY: 60,
      head: [['User ID','Region','Department','Usage (GB)','Entitled (GB)','Usage %']],
      body,
      styles: { fontSize: 9 },
      headStyles: { fillColor: [37,99,235] } // blue-600
    });

    doc.save('roaming-data-usage.pdf');
    showNotification('PDF generated', 'success');
  }catch(e){
    console.error(e);
    showNotification('PDF export failed', 'error');
  }
}

// Schedule Report (download .ics for Outlook)
function scheduleReport(){
  // Create a 30-min meeting for tomorrow 09:00 local time
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 9, 0, 0);
  const end   = new Date(start.getTime() + 30*60000);

  const toICS = dt => dt.toISOString()
                        .replace(/[-:]/g,'')
                        .replace(/\.\d{3}Z$/,'Z');

  const ics = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//Roaming Dashboard//EN',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `UID:${Date.now()}@roaming-dashboard`,
    `DTSTAMP:${toICS(new Date())}`,
    `DTSTART:${toICS(start)}`,
    `DTEND:${toICS(end)}`,
    'SUMMARY:Roaming Data Usage Review',
    `DESCRIPTION:Open the dashboard: https://jontrewyn.github.io/mobile-usage-dashboard/`,
    `URL:https://jontrewyn.github.io/mobile-usage-dashboard/`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  downloadFile(ics, 'roaming-report.ics', 'text/calendar;charset=utf-8;');
  showNotification('Calendar invite (ICS) downloaded', 'success');
}

// View All Alerts (modal)
function viewAllAlerts(){
  const critical = (filteredUsers.length ? filteredUsers : allUsers).filter(u => u.usage_percentage >= 150);
  const warning  = (filteredUsers.length ? filteredUsers : allUsers).filter(u => u.usage_percentage >= 100 && u.usage_percentage < 150);

  const section = (title, arr, color) => `
    <div>
      <h4 class="font-display text-md font-semibold text-${color}-800 mb-2">${title} <span class="text-${color}-600">(${arr.length})</span></h4>
      ${arr.length ? `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left py-2 pr-3 text-gray-700">User ID</th>
                <th class="text-left py-2 pr-3 text-gray-700">Region</th>
                <th class="text-left py-2 pr-3 text-gray-700">Department</th>
                <th class="text-right py-2 pr-3 text-gray-700">Usage (GB)</th>
                <th class="text-right py-2 pr-3 text-gray-700">Entitled (GB)</th>
                <th class="text-right py-2 pr-0 text-gray-700">% Used</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(u => `
                <tr class="border-b hover:bg-gray-50">
                  <td class="py-2 pr-3 font-mono">${escapeHtml(u.user_id)}</td>
                  <td class="py-2 pr-3">${escapeHtml(u.region)}</td>
                  <td class="py-2 pr-3">${escapeHtml(u.department)}</td>
                  <td class="py-2 pr-3 text-right font-mono">${u.total_usage_gb.toFixed(2)}</td>
                  <td class="py-2 pr-3 text-right font-mono">${u.entitled_gb}</td>
                  <td class="py-2 pr-0 text-right font-mono">${u.usage_percentage}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : `<p class="text-gray-500">No users in this category.</p>`}
    </div>
  `;

  const body = document.getElementById('alerts-modal-body');
  body.innerHTML = `
    ${section('Critical (>= 150%)', critical, 'red')}
    ${section('Warning (> 100% and < 150%)', warning, 'amber')}
  `;

  const modal = document.getElementById('alerts-modal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}
function closeAlertsModal(){
  const modal = document.getElementById('alerts-modal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

// File download helper
function downloadFile(content, filename, contentType){
  const blob = new Blob([content], { type: contentType });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

// Load JSON
async function refreshData(){
  const overlay = document.getElementById("loading-overlay");
  overlay.classList.remove("hidden"); overlay.classList.add("flex");
  try{
    const rsp = await fetch(JSON_URL, { cache: "no-store" });
    if (!rsp.ok) throw new Error(`JSON fetch failed: ${rsp.status}`);
    const json = await rsp.json();

    // Normalize to users[]
    allUsers = (json.top_users || []).map(u => ({
      user_id: u.User_ID || u.user_id,
      region: u.Region || u.region,
      department: u.Department || u.department || "Unknown",
      vas_code: u.VAS_Code || u.vas_code || "",
      total_usage_gb: u.Total_Usage_GB ?? u.total_usage_gb ?? 0,
      entitled_gb: u.Entitled_GB ?? u.entitled_gb ?? 6,
      usage_percentage: u.Usage_Percentage ?? u.usage_percentage ?? 0
    }));
    filteredUsers = allUsers.slice();

    updateTimestamp();
    renderKPIsFromUsers(filteredUsers);
    renderTable(filteredUsers);
  }catch(e){
    console.error(e);
    alert("Could not load JSON: " + e.message);
  }finally{
    overlay.classList.add("hidden"); overlay.classList.remove("flex");
  }
}

// Init
document.addEventListener("DOMContentLoaded", () => {
  if (typeof Typed !== "undefined"){
    new Typed('#dashboard-title', {
      strings: ['Roaming Data Usage Dashboard', 'Real-time Analytics Dashboard', 'Network Usage Monitor'],
      typeSpeed: 50, backSpeed: 30, backDelay: 2000, loop: true
    });
  }
  refreshData();
  setInterval(updateTimestamp, 60000);
});
